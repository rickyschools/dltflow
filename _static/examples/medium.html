
<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Medium Example - Multi-Method Decoration &#8212; dltflow 0.0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../graphviz.css?v=eafc0fe6" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script data-url_root="../../" id="documentation_options" src="../documentation_options.js?v=f6245a2f"></script>
    <script src="../doctools.js?v=888ff710"></script>
    <script src="../sphinx_highlight.js?v=4825356b"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_static/examples/medium';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Streaming Append Example" href="streaming_append.html" />
    <link rel="prev" title="Simple Example - Single Method Decorated" href="simple.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">dltflow 0.0.1 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../examples.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../references.html">
                        Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../autoapi/index.html">
                        API Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../examples.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../references.html">
                        Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../autoapi/index.html">
                        API Reference
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="simple.html">Simple Example - Single Method Decorated</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Medium Example - Multi-Method Decoration</a></li>
<li class="toctree-l1"><a class="reference internal" href="streaming_append.html">Streaming Append Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="streaming_cdc.html">Streaming Apply Changes Example</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../examples.html" class="nav-link">Examples</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Medium...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="medium-example-multi-method-decoration">
<h1>Medium Example - Multi-Method Decoration<a class="headerlink" href="#medium-example-multi-method-decoration" title="Permalink to this heading">#</a></h1>
<p>This article intends to depict how to use <code class="docutils literal notranslate"><span class="pre">dltflow</span></code> in a slightly more complex example. The core components of this
example will indent to show how <code class="docutils literal notranslate"><span class="pre">dltflow</span></code> can be configured to wrap multiple functions in a single python module.</p>
<p>Our structure for this article will follow that of our simple example.</p>
<ul class="simple">
<li><p><a class="reference internal" href="#code">Code</a></p></li>
<li><p><a class="reference internal" href="#configuration">Configuration</a></p></li>
<li><p><a class="reference internal" href="#workflow-spec">Workflow Spec</a></p></li>
<li><p><a class="reference internal" href="#deployment">Deployment</a></p></li>
</ul>
<section id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this heading">#</a></h2>
<section id="base-pipeline-code">
<h3>Base Pipeline Code<a class="headerlink" href="#base-pipeline-code" title="Permalink to this heading">#</a></h3>
<p>All pipelines leverage a <code class="docutils literal notranslate"><span class="pre">base_pipeline.py</span></code> file for the example that provides a common <code class="docutils literal notranslate"><span class="pre">PipelineBase</span></code> class that each
pipeline inherits from. This is provided to help standardize how things like <code class="docutils literal notranslate"><span class="pre">spark</span></code>, <code class="docutils literal notranslate"><span class="pre">logging</span></code>, and <code class="docutils literal notranslate"><span class="pre">configuration</span></code> are
initialized in pipelines. This pattern largely follows <code class="docutils literal notranslate"><span class="pre">dbx</span></code>’s documentation and task templating guide.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>


<span class="k">class</span> <span class="nc">PipelineBase</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spark</span><span class="p">:</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">init_conf</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spark</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provide_config</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">init_conf</span> <span class="k">else</span> <span class="n">init_conf</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_spark</span><span class="p">(</span><span class="n">spark</span><span class="p">:</span> <span class="n">SparkSession</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spark</span><span class="p">:</span>
            <span class="n">spark</span> <span class="o">=</span> <span class="n">builder</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[1]&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;dltflow-examples&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">spark</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_conf_file</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Uses the arg parser to extract the config location from cli.&quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--conf-file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">namespace</span><span class="o">.</span><span class="n">conf_file</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_config</span><span class="p">(</span><span class="n">conf_file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">conf_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">_provide_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Orchestrates getting configuration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading configuration from --conf-file job option&quot;</span><span class="p">)</span>
        <span class="n">conf_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_conf_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;No conf file was provided, setting configuration to empty dict.&quot;</span>
                <span class="s2">&quot;Please override configuration in subclass init method&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Conf file was provided, reading configuration from </span><span class="si">{</span><span class="n">conf_file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_config</span><span class="p">(</span><span class="n">conf_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Logger</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets up the logger and ensures our job uses the log4j provided by spark.&quot;&quot;&quot;</span>
        <span class="n">log4j_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">log4j</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="n">log4j_logger</span><span class="o">.</span><span class="n">LogManager</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that we understand that what <code class="docutils literal notranslate"><span class="pre">base_pipeline.py</span></code> does, lets get into our sample code.</p>
</section>
<section id="example-pipeline-code">
<h3>Example Pipeline Code<a class="headerlink" href="#example-pipeline-code" title="Permalink to this heading">#</a></h3>
<p>For this example we will have a slightly more complex pipeline. In this code base, we will:</p>
<ul class="simple">
<li><p>Import a <code class="docutils literal notranslate"><span class="pre">DLTMetaMixin</span></code> from <code class="docutils literal notranslate"><span class="pre">dltflow.quality</span></code> and will tell our sample pipeline to inherit from it.</p></li>
<li><p>Create sample data in memory.</p></li>
<li><p>We’ll <code class="docutils literal notranslate"><span class="pre">transform</span></code> that data in two steps.</p></li>
<li><p>In an intermediate step, we will ensure people’s ages are between 10 and 100.</p></li>
<li><p>In a following step, we will get a count of people in our sample dataset by age range.</p></li>
<li><p>Both the intermediate and final transformations will be registered in the <code class="docutils literal notranslate"><span class="pre">dlt</span></code> pipeline.</p>
<ul>
<li><p>This will be as a <code class="docutils literal notranslate"><span class="pre">view</span></code> and a <code class="docutils literal notranslate"><span class="pre">materialized</span> <span class="pre">table</span></code> respectively.</p></li>
</ul>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dltflow.quality</span> <span class="kn">import</span> <span class="n">DLTMetaMixin</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">DataFrame</span> <span class="k">as</span> <span class="n">SparkDataFrame</span><span class="p">,</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">f</span>

<span class="kn">from</span> <span class="nn">.base_pipeline</span> <span class="kn">import</span> <span class="n">PipelineBase</span>


<span class="k">class</span> <span class="nc">MyMediumPipeline</span><span class="p">(</span><span class="n">PipelineBase</span><span class="p">,</span> <span class="n">DLTMetaMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spark</span><span class="p">:</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">init_conf</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">spark</span><span class="o">=</span><span class="n">spark</span><span class="p">,</span> <span class="n">init_conf</span><span class="o">=</span><span class="n">init_conf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">intermediate_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">SparkDataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SparkDataFrame</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SparkDataFrame</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Charlie&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;David&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Eve&quot;</span><span class="p">,</span> <span class="mi">78</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Frank&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Grace&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Heidi&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Ivan&quot;</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Judy&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Kevin&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Lana&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Mona&quot;</span><span class="p">,</span> <span class="mi">105</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Nina&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Omar&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Pam&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Quinn&quot;</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Rita&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Steve&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Tina&quot;</span><span class="p">,</span> <span class="mi">115</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Uma&quot;</span><span class="p">,</span> <span class="mi">78</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Vera&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Wendy&quot;</span><span class="p">,</span> <span class="mi">56</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Xander&quot;</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Yara&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;Zack&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">SparkDataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SparkDataFrame</span><span class="p">:</span>
        <span class="n">out_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_step</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">out_step2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">out_step</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;age_bin&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">),</span> <span class="mi">10</span><span class="p">))</span>
            <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;age_bin_str&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;age_bin_&quot;</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;age_bin&quot;</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;age_bin_str&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">out_step2</span>

    <span class="k">def</span> <span class="nf">orchestrate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</section>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">#</a></h2>
<p>Now that we have our example code, we need to write our configuration to tell the <code class="docutils literal notranslate"><span class="pre">DLTMetaMixin</span></code> how wrap our codebase.</p>
<p>Under the hood, <code class="docutils literal notranslate"><span class="pre">dltflow</span></code> uses <code class="docutils literal notranslate"><span class="pre">pydantic</span></code> to create validation for configuration. When working with <code class="docutils literal notranslate"><span class="pre">dltflow</span></code>, it
requires your configuration to adhere to a specific structure. Namely, file should have the following sections:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reader</span></code>: This is helpful for telling your pipeline where to read data from.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">writer</span></code>: Used to define where your data is written to after being processed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dlt</span></code>: Defines how <code class="docutils literal notranslate"><span class="pre">dlt</span></code> will be used in the project. We use this to dynamically wrap your code with <code class="docutils literal notranslate"><span class="pre">dlt</span></code> commands.</p></li>
</ul>
<p>With this brief overview out of the way, lets review our configuration for this sample.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span><span class="p">:</span>
  <span class="o">...</span>
<span class="n">writer</span><span class="p">:</span>
  <span class="n">adl_processed_path</span><span class="p">:</span> <span class="s2">&quot;a/fake/path&quot;</span>
  <span class="n">schema</span><span class="p">:</span> <span class="n">fake_schema</span>
  <span class="n">table_name</span><span class="p">:</span> <span class="n">table_name</span>
<span class="n">dlt</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">func_name</span><span class="p">:</span> <span class="s2">&quot;orchestrate&quot;</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">table</span>
    <span class="n">expectation_action</span><span class="p">:</span> <span class="s2">&quot;drop&quot;</span>
    <span class="n">expectations</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;check_count&quot;</span>
        <span class="n">constraint</span><span class="p">:</span> <span class="s2">&quot;count &lt;= 10&quot;</span>
  <span class="o">-</span> <span class="n">func_name</span><span class="p">:</span> <span class="s2">&quot;intermediate_step&quot;</span>
    <span class="n">kind</span><span class="p">:</span> <span class="n">view</span>
    <span class="n">expectation_action</span><span class="p">:</span> <span class="s2">&quot;drop&quot;</span>
    <span class="n">expectations</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;check_age&quot;</span>
        <span class="n">constraint</span><span class="p">:</span> <span class="s2">&quot;age between 10 and 100&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">dlt</span></code> section in this example is a list of <code class="docutils literal notranslate"><span class="pre">DLTConfig</span></code>’s.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">func_name</span></code>: The name of the function/method we want <code class="docutils literal notranslate"><span class="pre">dlt</span></code> to decorate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kind</span></code>: Tells <code class="docutils literal notranslate"><span class="pre">dlt</span></code> if this query should be materialized as a <code class="docutils literal notranslate"><span class="pre">table</span></code> or <code class="docutils literal notranslate"><span class="pre">view</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">expectation_action</span></code>: Tells <code class="docutils literal notranslate"><span class="pre">dlt</span></code> how to handle the expectations. <code class="docutils literal notranslate"><span class="pre">drop</span></code>, <code class="docutils literal notranslate"><span class="pre">fail</span></code>, and <code class="docutils literal notranslate"><span class="pre">allow</span></code> are all supported.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">expectations</span></code>: These are a list of constraints we want to apply to our data.</p></li>
</ul>
</section>
<section id="workflow-spec">
<h2>Workflow Spec<a class="headerlink" href="#workflow-spec" title="Permalink to this heading">#</a></h2>
<p>Now that we’ve gone through the code and configuration, we need to start defining the workflow that we want to deploy
to Databricks so that our pipeline can be registered as a DLT Pipeline. This structure largely follows the <a class="reference internal" href="../examples.html"><span class="doc std std-doc">Databricks
Pipeline API</span></a> with the addition of a <code class="docutils literal notranslate"><span class="pre">tasks</span></code> key. This key is used during deployment for transitioning your python
module into a Notebook that can be deployed as a DLT Pipeline.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dev</span><span class="p">:</span>
  <span class="n">workflows</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;dltflow-medium-pipeline_with_expectations&quot;</span>
      <span class="n">storage</span><span class="p">:</span> <span class="s2">&quot;/mnt/igdatalake/experiment/dltflow-samples/dlt/medium&quot;</span>
      <span class="n">target</span><span class="p">:</span> <span class="s2">&quot;dltflow-samples&quot;</span>
      <span class="n">development</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
      <span class="n">edition</span><span class="p">:</span> <span class="s2">&quot;ADVANCED&quot;</span>
      <span class="n">continuous</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
      <span class="n">clusters</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">label</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
          <span class="n">node_type_id</span><span class="p">:</span> <span class="n">Standard_DS3_v2</span><span class="s2">&quot;</span>
          <span class="n">autoscale</span><span class="p">:</span>
            <span class="n">min_workers</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">max_workers</span><span class="p">:</span> <span class="mi">2</span>
            <span class="n">mode</span><span class="p">:</span> <span class="s2">&quot;ENHANCED&quot;</span>
      <span class="n">pipeline_type</span><span class="p">:</span> <span class="s2">&quot;WORKSPACE&quot;</span>
      <span class="n">data_sampling</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">tasks</span><span class="p">:</span>
        <span class="n">items</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">python_file</span><span class="p">:</span> <span class="s2">&quot;pipelines/medium_dlt_pipeline_with_expectations.py&quot;</span>
            <span class="n">parameters</span><span class="p">:</span>
              <span class="o">-</span> <span class="s2">&quot;--conf&quot;</span>
              <span class="o">-</span> <span class="s2">&quot;conf/medium_dlt_pipeline_with_expectations.yml&quot;</span>
        <span class="n">dependencies</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">whl</span><span class="p">:</span> <span class="s2">&quot;/dbfs/private-site-packages/dltflow-0.0.1b0-py3-none-any.whl&quot;</span>
          <span class="o">-</span> <span class="n">pypi</span><span class="p">:</span>
              <span class="n">package</span><span class="p">:</span> <span class="s2">&quot;pyspark&quot;</span>
</pre></div>
</div>
</section>
<section id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this heading">#</a></h2>
<p>We’re at the final step of this simple example. The last piece of the puzzle here is that we need to deploy our assets
to a Databricks workspace. To do so, we’ll use the <code class="docutils literal notranslate"><span class="pre">dltflow</span></code> cli.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># bin/sh</span>

<span class="n">dltflow</span> <span class="n">deploy</span><span class="o">-</span><span class="n">py</span><span class="o">-</span><span class="n">dlt</span> <span class="o">--</span><span class="n">deployment</span><span class="o">-</span><span class="n">file</span> <span class="o">../</span><span class="n">workflows</span><span class="o">/</span><span class="n">medium_dlt_pipeline_with_expectations</span><span class="o">.</span><span class="n">yml</span> \
  <span class="o">--</span><span class="n">environment</span> <span class="n">dev</span> <span class="o">--</span><span class="k">as</span><span class="o">-</span><span class="n">individual</span>
</pre></div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="simple.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Simple Example - Single Method Decorated</p>
      </div>
    </a>
    <a class="right-next"
       href="streaming_append.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Streaming Append Example</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code">Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#base-pipeline-code">Base Pipeline Code</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-pipeline-code">Example Pipeline Code</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workflow-spec">Workflow Spec</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deployment">Deployment</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/_static/examples/medium.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Ricky Schools.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>